stages:
- build-container

build-container:
  image: docker:27.0.3
  cache: {}
  variables:
    DOCKER_HOST: tcp://docker:2376
    BUILDKIT_HOST: buildkit://buildkitd
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  services:
  - docker:27.0.3-dind
  - moby/buildkit:latest as buildkit
  stage: build-container
  script:
  - until docker info; do sleep 1; done
  - docker login --username=$HARBOR_USERNAME --password=$HARBOR_PASSWORD $HARBOR_URL
  - docker buildx ls
  - docker buildx create --name mybuilder --platform linux/arm64,linux/arm64 --driver-opt image=moby/buildkit:latest --use
  - sleep 30
  - docker buildx ls
  - docker buildx use mybuilder
  - docker ps -a
  - docker buildx build --platform linux/amd64,linux/arm64 --push -t $HARBOR_HOST/$HARBOR_PROJECT/pgpool:$CI_COMMIT_SHORT_SHA -t $HARBOR_HOST/$HARBOR_PROJECT/pgpool:latest pgpool
